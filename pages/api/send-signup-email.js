import nodemailer from "nodemailer";

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ message: "Method not allowed" });
  }

  const {
    firstName,
    fullName,
    email,
    phone,
    phoneNumber,
    category,
    message,
    countryCode,
    referringPage,
    currentPage,
    userIP,
    userCity,
    userRegion,
    userCountry,
    formType, 
  } = req.body;

  try {
    const transporter = nodemailer.createTransport({
      host: "smtp.gmail.com",
      port: 465,
      secure: true,
      auth: {
        user: "pinebookwriting@gmail.com",
        pass: "owwwkmrznsnddjtm",
      },
    });

    // Determine which form was submitted
    const isContactForm = formType === 'contact' || fullName;
    const userName = isContactForm ? fullName : firstName;
    const userPhone = isContactForm ? phoneNumber : phone;

    if (isContactForm) {
      // Contact Form Email Templates
      const adminHtmlContent = `
        <div style="font-family: Arial, sans-serif; background-color:#f8f9fa; padding: 20px;">
          <div style="max-width:600px; margin:0 auto; background:#ffffff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <div style="background:#0d0f38; color:#ffffff; padding:16px 24px; border-radius:8px 8px 0 0;">
              <h2 style="margin:0;">New Contact Form Submission - ${userName || "User"}</h2>
            </div>
            <div style="padding:24px; color:#333333;">
              <p style="margin-bottom:16px;">You have received a new contact form submission. Details are below:</p>
              <table style="width:100%; border-collapse:collapse;">
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Name:</td>
                  <td>${userName}</td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Email:</td>
                  <td><a href="mailto:${email}" style="color:#0d6efd;">${email}</a></td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Phone:</td>
                  <td>${countryCode || "+1"} ${userPhone}</td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Message:</td>
                  <td>${message || "N/A"}</td>
                </tr>
                ${userIP ? `
                <tr>
                  <td style="padding:8px 0; font-weight:600;">IP Address:</td>
                  <td>${userIP}</td>
                </tr>
                ` : ''}
                ${userCity ? `
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Location:</td>
                  <td>${userCity}, ${userRegion}, ${userCountry}</td>
                </tr>
                ` : ''}
                ${referringPage ? `
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Referrer:</td>
                  <td><a href="${referringPage}" style="color:#0d6efd;">${referringPage}</a></td>
                </tr>
                ` : ''}
                ${currentPage ? `
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Current Page:</td>
                  <td><a href="${currentPage}" style="color:#0d6efd;">${currentPage}</a></td>
                </tr>
                ` : ''}
              </table>
            </div>
            <div style="background:#f1f3f5; color:#555; padding:12px 24px; border-top:1px solid #e9ecef; border-radius:0 0 8px 8px; font-size:13px;">
              <p style="margin:0;">üì¨ This email was automatically generated by Pine Book Publishing contact form.</p>
            </div>
          </div>
        </div>
      `;

      const userHtmlContent = `
        <div style="font-family: Arial, sans-serif; background-color:#f8f9fa; padding: 20px;">
          <div style="max-width:600px; margin:0 auto; background:#ffffff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <div style="background:#0d0f38; color:#ffffff; padding:24px; border-radius:8px 8px 0 0; text-align:center;">
              <h1 style="margin:0; font-size:28px;">Thank You, ${userName}! üéâ</h1>
            </div>
            <div style="padding:32px 24px; color:#333333;">
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                <strong>Dear Author,</strong>
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                Thank you for signing up with Pine Book Publishing.
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:24px;">
                 We‚Äôd love to schedule a call to discuss your book publishing in more detail.
                Please let us know a time that works best for you so we can connect and talk further.
                I‚Äôd really appreciate hearing back from you.
                </p>
              <div style="background:#f8f9fa; padding:20px; border-radius:6px; border-left:4px solid #0d0f38; margin:24px 0;">
                <p style="margin:0 0 12px 0; font-weight:600; color:#0d0f38;">Your Message Details:</p>
                <table style="width:100%; font-size:14px;">
                  <tr>
                    <td style="padding:6px 0; color:#666;">Name:</td>
                    <td style="padding:6px 0; font-weight:600;">${userName}</td>
                  </tr>
                  <tr>
                    <td style="padding:6px 0; color:#666;">Email:</td>
                    <td style="padding:6px 0;">${email}</td>
                  </tr>
                  <tr>
                    <td style="padding:6px 0; color:#666;">Phone:</td>
                    <td style="padding:6px 0;">${countryCode || "+1"} ${userPhone}</td>
                  </tr>
                </table>
              </div>

              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                <strong>Thank you and best regards,</strong>
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                 <strong>Pine Book Publishing Team</strong>
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                   Email: support@pinebookpublishing.com
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                   Call: +1 (866) 841-7463
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                   WhatsApp: +1 (866) 841-7463
              </p>
              
              <div style="text-align:center; margin-top:32px;">
                <a href="https://pinebookpublishing.com/book-publishing-offer" style="display:inline-block; background:#0d0f38; color:#ffffff; padding:14px 32px; text-decoration:none; border-radius:6px; font-weight:600; font-size:16px;">
                  Visit Our Website
                </a>
              </div>
            </div>
            <div style="background:#f1f3f5; color:#666; padding:20px 24px; border-top:1px solid #e9ecef; border-radius:0 0 8px 8px; font-size:13px; text-align:center;">
              <p style="margin:0 0 8px 0;">üìß Pine Book Publishing</p>
              <p style="margin:0;">If you have any immediate questions, reply to this email or contact us at support@pinebookpublishing.com</p>
            </div>
          </div>
        </div>
      `;

      const adminInfo = await transporter.sendMail({
        from: `"Pine Book Publishing" <sales@pinebookpublishing.com>`,
        to: "sales@pinebookpublishing.com",
        subject: `New Contact Form - ${userName || "User"}`,
        html: adminHtmlContent,
      });

      console.log("Admin email sent:", adminInfo.messageId);

      const userInfo = await transporter.sendMail({
        from: `"Pine Book Publishing" <sales@pinebookpublishing.com>`,
        to: email,
        subject: `Let‚Äôs Discuss Your Book Publishing`,
        html: userHtmlContent,
      });

      console.log("‚úÖ User thank you email sent:", userInfo.messageId);

      return res.status(200).json({
        success: true,
        message: "Contact form emails sent successfully",
        adminMessageId: adminInfo.messageId,
        userMessageId: userInfo.messageId,
      });

    } else {
      // Original Sign Up Form Email Templates
      const adminHtmlContent = `
        <div style="font-family: Arial, sans-serif; background-color:#f8f9fa; padding: 20px;">
          <div style="max-width:600px; margin:0 auto; background:#ffffff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <div style="background:#0d0f38; color:#ffffff; padding:16px 24px; border-radius:8px 8px 0 0;">
              <h2 style="margin:0;">New Sign Up - ${userName || "User"}</h2>
            </div>
            <div style="padding:24px; color:#333333;">
              <p style="margin-bottom:16px;">You have received a new sign-up on your website. Details are below:</p>
              <table style="width:100%; border-collapse:collapse;">
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Name:</td>
                  <td>${userName}</td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Email:</td>
                  <td><a href="mailto:${email}" style="color:#0d6efd;">${email}</a></td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Phone:</td>
                  <td>${countryCode || ""} ${userPhone}</td>
                </tr> 
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Service:</td>
                  <td>${category}</td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Message:</td>
                  <td>${message || "N/A"}</td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">IP Address:</td>
                  <td>${userIP}</td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Location:</td>
                  <td>${userCity}, ${userRegion}, ${userCountry}</td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Referrer:</td>
                  <td><a href="${referringPage}" style="color:#0d6efd;">${referringPage}</a></td>
                </tr>
                <tr>
                  <td style="padding:8px 0; font-weight:600;">Current Page:</td>
                  <td><a href="${currentPage}" style="color:#0d6efd;">${currentPage}</a></td>
                </tr>
              </table>
            </div>
            <div style="background:#f1f3f5; color:#555; padding:12px 24px; border-top:1px solid #e9ecef; border-radius:0 0 8px 8px; font-size:13px;">
              <p style="margin:0;">üì¨ This email was automatically generated by Pine Book Publishing website form.</p>
            </div>
          </div>
        </div>
      `;

      const userHtmlContent = `
        <div style="font-family: Arial, sans-serif; background-color:#f8f9fa; padding: 20px;">
          <div style="max-width:600px; margin:0 auto; background:#ffffff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
            <div style="background:#0d0f38; color:#ffffff; padding:24px; border-radius:8px 8px 0 0; text-align:center;">
              <h1 style="margin:0; font-size:28px;">Thank You, ${userName}! üéâ</h1>
            </div>
            <div style="padding:32px 24px; color:#333333;">
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                <strong>Dear Author,</strong>
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                Thank you for signing up with Pine Book Publishing.
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:24px;">
                 We‚Äôd love to schedule a call to discuss your book publishing in more detail.
                Please let us know a time that works best for you so we can connect and talk further.
                I‚Äôd really appreciate hearing back from you.
                </p>
              
              <div style="background:#f8f9fa; padding:20px; border-radius:6px; border-left:4px solid #0d0f38; margin:24px 0;">
                <p style="margin:0 0 12px 0; font-weight:600; color:#0d0f38;">Your Submission Details:</p>
                <table style="width:100%; font-size:14px;">
                  <tr>
                    <td style="padding:6px 0; color:#666;">Service:</td>
                    <td style="padding:6px 0; font-weight:600;">${category}</td>
                  </tr>
                  <tr>
                    <td style="padding:6px 0; color:#666;">Email:</td>
                    <td style="padding:6px 0;">${email}</td>
                  </tr>
                  <tr>
                    <td style="padding:6px 0; color:#666;">Phone:</td>
                    <td style="padding:6px 0;">${countryCode || ""} ${userPhone}</td>
                  </tr>
                </table>
              </div>

               <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                <strong>Thank you and best regards,</strong>
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                 <strong>Pine Book Publishing Team</strong>
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                   Email: support@pinebookpublishing.com
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                   Call: +1 (866) 841-7463
              </p>
              <p style="font-size:16px; line-height:1.6; margin-bottom:16px;">
                   WhatsApp: +1 (866) 841-7463
              </p>
              
              
              <div style="text-align:center; margin-top:32px;">
                <a href="https://pinebookpublishing.com/book-publishing-offer" style="display:inline-block; background:#0d0f38; color:#ffffff; padding:14px 32px; text-decoration:none; border-radius:6px; font-weight:600; font-size:16px;">
                  Visit Our Website
                </a>
              </div>
            </div>
            <div style="background:#f1f3f5; color:#666; padding:20px 24px; border-top:1px solid #e9ecef; border-radius:0 0 8px 8px; font-size:13px; text-align:center;">
              <p style="margin:0 0 8px 0;">üìß Pine Book Publishing</p>
              <p style="margin:0;">If you have any immediate questions, reply to this email or contact us at support@pinebookpublishing.com</p>
            </div>
          </div>
        </div>
      `;

      const adminInfo = await transporter.sendMail({
        from: `"Pine Book Publishing" <sales@pinebookpublishing.com>`,
        to: "sales@pinebookpublishing.com",
        subject: `New Sign Up - ${userName || "User"}`,
        html: adminHtmlContent,
      });

      console.log("Admin email sent:", adminInfo.messageId);

      const userInfo = await transporter.sendMail({
        from: `"Pine Book Publishing" <sales@pinebookpublishing.com>`,
        to: email,
        subject: `Let‚Äôs Discuss Your Book Publishing`,
        html: userHtmlContent,
      });

      console.log("‚úÖ User thank you email sent:", userInfo.messageId);

      return res.status(200).json({
        success: true,
        message: "Emails sent successfully",
        adminMessageId: adminInfo.messageId,
        userMessageId: userInfo.messageId,
      });
    }
  } catch (error) {
    console.error("‚ùå Error sending email:", error);
    return res.status(500).json({
      success: false,
      message: "Failed to send email",
      error: error.message,
    });
  }
}